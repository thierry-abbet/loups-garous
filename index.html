<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loups-Garous Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React UMD (Architecture Test.html) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1c1917; color: white; overflow: hidden; }
        h1, h2, h3, .font-serif { font-family: 'Crimson Text', serif; }
        .banned-cross { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: #ef4444; font-size: 3rem; font-weight: bold; pointer-events: none; }
        .required-dot { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; box-shadow: 0 0 5px #22c55e; }
        .animate-bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }
        /* Fallback visual for roles */
        .role-fallback { display: flex; align-items: center; justify-content: center; border-radius: 9999px; border-width: 2px; font-weight: bold; color: white; flex-shrink: 0; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const VERSION = "v3.6";
        // Utilisation des URLs brutes GitHub pour √©viter les probl√®mes de cache/chemin relatif
        const IMG_BASE_URL = "https://raw.githubusercontent.com/thierry-abbet/loups-garous/main/public/images/";

        // --- DATA ---
        const ROLES = [
            { id: 'cupid', name: 'Cupidon', type: 'VILLAGER', imageSrc: 'v-cupidon.png' },
            { id: 'lovers', name: 'Les Amoureux', type: 'SPECIAL', imageSrc: 'v-cupidon.png' },
            { id: 'seer', name: 'La Voyante', type: 'VILLAGER', imageSrc: 'v-voyante.png' },
            { id: 'simple_wolf', name: 'Simple Loup-Garou', type: 'WOLF', imageSrc: 'l-simple.png' },
            { id: 'infect_father', name: 'Infect P√®re des Loups', type: 'WOLF', imageSrc: 'l-infect.png' },
            { id: 'big_bad_wolf', name: 'Grand M√©chant Loup', type: 'WOLF', imageSrc: 'l-grand.png' },
            { id: 'witch', name: 'La Sorci√®re', type: 'VILLAGER', imageSrc: 'v-sorciere.png' },
            { id: 'hunter', name: 'Le Chasseur', type: 'VILLAGER', imageSrc: 'v-chasseur.png' },
            { id: 'sisters', name: 'Les Deux S≈ìurs', type: 'VILLAGER', imageSrc: 'v-soeurs.png' },
            { id: 'little_girl', name: 'La Petite Fille', type: 'VILLAGER', imageSrc: 'v-petitefille.png' },
            { id: 'fox', name: 'Le Renard', type: 'VILLAGER', imageSrc: 'v-renard.png' },
            { id: 'rusty_knight', name: 'Chevalier √âp√©e Rouill√©e', type: 'VILLAGER', imageSrc: 'v-chevalier.png' },
            { id: 'elder', name: "L'Ancien", type: 'VILLAGER', imageSrc: 'v-ancien.png' },
            { id: 'bear_tamer', name: "Montreur d'Ours", type: 'VILLAGER', imageSrc: 'v-ours.png' },
            { id: 'simple_villager', name: 'Simple Villageois', type: 'VILLAGER', imageSrc: 'v-simple.png' },
            { id: 'wild_child', name: 'Enfant Sauvage', type: 'AMBIGUOUS', imageSrc: 'a-enfantsauvage.png' },
            { id: 'dog_wolf', name: 'Chien-Loup', type: 'AMBIGUOUS', imageSrc: 'a-chienloup.png' },
            { id: 'white_wolf', name: 'Loup-Garou Blanc', type: 'LONER', imageSrc: 's-lgblanc.png' },
            { id: 'flute_player', name: 'Joueur de Fl√ªte', type: 'LONER', imageSrc: 's-flute.png' },
            { id: 'angel', name: "L'Ange", type: 'LONER', imageSrc: 's-ange.png' }
        ];

        // --- COMPONENTS ---

        const RoleImg = ({ rid, size = "w-12 h-12" }) => {
            const r = ROLES.find(x => x.id === rid);
            if (!r) return null;
            
            // Construction de l'URL absolue
            const imgSrc = IMG_BASE_URL + r.imageSrc;
            
            // Fallback Colors
            let bgFallback = "bg-stone-700 border-stone-500";
            if (r.type === 'WOLF') bgFallback = "bg-red-900 border-red-700";
            if (r.type === 'VILLAGER') bgFallback = "bg-green-900 border-green-700";
            if (r.type === 'AMBIGUOUS') bgFallback = "bg-purple-900 border-purple-700";
            if (r.type === 'LONER') bgFallback = "bg-slate-700 border-slate-500";
            
            const shortName = r.name.substring(0, 2);

            return (
                <div className={`relative ${size} shrink-0`}>
                    <img 
                        src={imgSrc} 
                        className={`absolute inset-0 w-full h-full object-contain drop-shadow-md z-10`}
                        alt={r.name}
                        onError={(e) => {
                            console.warn(`Image loading failed: ${imgSrc}`);
                            e.target.style.display = 'none';
                            e.target.nextSibling.style.display = 'flex'; // Show fallback
                        }}
                    />
                    <div 
                        className={`absolute inset-0 w-full h-full role-fallback ${bgFallback} text-xs hidden`}
                    >
                        {shortName}
                    </div>
                </div>
            );
        };

        const App = () => {
            // -- STATE --
            const [phase, setPhase] = useState('SETUP'); // SETUP, REVIEW, GAME, VICTORY
            const [playerCount, setPlayerCount] = useState(8);
            const [difficulty, setDifficulty] = useState('MOYENNE');
            const [roleStatus, setRoleStatus] = useState({}); // { [id]: 'NEUTRAL' | 'BANNED' | 'REQUIRED' }
            
            // Game State
            const [players, setPlayers] = useState([]); // { uid, roleId, isAlive, isLover }
            const [turn, setTurn] = useState(1);
            const [isDay, setIsDay] = useState(false);
            const [historyLog, setHistoryLog] = useState([]);
            const [storyStep, setStoryStep] = useState(0);
            const [nightKills, setNightKills] = useState([]);
            const [witchUsed, setWitchUsed] = useState({ life: false, death: false });
            const [infectUsed, setInfectUsed] = useState(false);
            const [elderLives, setElderLives] = useState(2);
            const [powersLost, setPowersLost] = useState(false);
            
            // UI State
            const [showDashboard, setShowDashboard] = useState(false);
            const [victory, setVictory] = useState(null);

            // -- HELPERS --

            const log = (text) => {
                setHistoryLog(prev => [`[${isDay ? 'Jour' : 'Nuit'} ${turn}] ${text}`, ...prev]);
            };

            const getRole = (rid) => ROLES.find(r => r.id === rid);

            const checkVictory = () => {
                const alive = players.filter(p => p.isAlive);
                const wolves = alive.filter(p => getRole(p.roleId).type === 'WOLF' || p.roleId === 'white_wolf');
                const villagers = alive.filter(p => getRole(p.roleId).type !== 'WOLF' && p.roleId !== 'white_wolf' && p.roleId !== 'flute_player' && p.roleId !== 'angel');
                const lovers = alive.filter(p => p.isLover);
                const angel = players.find(p => p.roleId === 'angel');

                let win = null;
                // Ange
                if (angel && !angel.isAlive && turn === 1 && isDay) {
                    win = { winner: "L'Ange", reason: "Il a r√©ussi son suicide au premier tour !" };
                }
                // Amoureux
                else if (lovers.length === 2 && alive.length === 2) {
                    win = { winner: "Les Amoureux", reason: "Ils sont seuls au monde." };
                }
                // Loup Blanc
                else if (wolves.length === 1 && wolves[0].roleId === 'white_wolf' && villagers.length === 0) {
                    win = { winner: "Le Loup Blanc", reason: "Il est le dernier survivant." };
                }
                // Loups
                else if (wolves.length > 0 && villagers.length === 0) {
                    win = { winner: "Les Loups", reason: "Le village a √©t√© enti√®rement d√©vor√©." };
                }
                // Villageois
                else if (wolves.length === 0 && villagers.length > 0) {
                    win = { winner: "Les Villageois", reason: "Tous les loups ont √©t√© √©limin√©s." };
                }

                if (win) {
                    setVictory(win);
                    setPhase('VICTORY');
                }
            };

            const killPlayer = (uid, reason) => {
                const pIndex = players.findIndex(p => p.uid === uid);
                if (pIndex === -1 || !players[pIndex].isAlive) return;

                const newPlayers = [...players];
                const p = newPlayers[pIndex];
                p.isAlive = false;
                const r = getRole(p.roleId);

                // Logique Ancien
                if (p.roleId === 'elder' && reason === 'Vote du Village') {
                    setPowersLost(true);
                    log("üíÄ L'Ancien est mort par le vote ! Tous les pouvoirs du village sont perdus !");
                } else {
                    log(`${r.name} est mort (${reason}).`);
                }

                // Logique Amoureux
                if (p.isLover) {
                    const loverIndex = newPlayers.findIndex(x => x.isLover && x.uid !== uid && x.isAlive);
                    if (loverIndex !== -1) {
                        newPlayers[loverIndex].isAlive = false;
                        const lr = getRole(newPlayers[loverIndex].roleId);
                        log(`üíî ${lr.name} meurt de chagrin !`);
                    }
                }

                setPlayers(newPlayers);
                
                if (p.roleId === 'hunter') {
                    alert("LE CHASSEUR EST MORT ! IL DOIT TIRER !");
                    log("üî´ Le Chasseur tire avant de mourir.");
                }
            };

            // Effet pour checker la victoire quand les joueurs changent
            useEffect(() => {
                if (phase === 'GAME') checkVictory();
            }, [players]);

            const revivePlayer = (uid) => {
                const newPlayers = players.map(p => p.uid === uid ? { ...p, isAlive: true } : p);
                setPlayers(newPlayers);
                const p = players.find(x => x.uid === uid);
                log(`‚ú® ${getRole(p.roleId).name} a √©t√© ressuscit√©.`);
            };

            // --- GENERATION ---

            const cycleRoleStatus = (rid) => {
                setRoleStatus(prev => {
                    const current = prev[rid] || 'NEUTRAL';
                    const next = current === 'NEUTRAL' ? 'BANNED' : current === 'BANNED' ? 'REQUIRED' : 'NEUTRAL';
                    return { ...prev, [rid]: next };
                });
            };

            const generateGame = () => {
                let roster = [];
                const required = ROLES.filter(r => roleStatus[r.id] === 'REQUIRED' && r.id !== 'lovers');
                const bannedIds = new Set(ROLES.filter(r => roleStatus[r.id] === 'BANNED').map(r => r.id));
                bannedIds.add('lovers'); 

                required.forEach(r => {
                    roster.push(r.id);
                    if (r.id === 'sisters') roster.push(r.id); 
                });

                if (roster.length > playerCount) {
                    alert("Trop de r√¥les requis pour le nombre de joueurs !");
                    return;
                }

                const maxWolves = Math.max(1, Math.floor(playerCount / 4));
                let currentWolves = roster.filter(rid => getRole(rid).type === 'WOLF').length;
                const wolfPool = ROLES.filter(r => (r.type === 'WOLF' || r.id === 'white_wolf') && !bannedIds.has(r.id) && !roster.includes(r.id));

                while (currentWolves < maxWolves && roster.length < playerCount) {
                    if (wolfPool.length > 0 && Math.random() < (difficulty === 'FACILE' ? 0.2 : 0.6)) {
                        const idx = Math.floor(Math.random() * wolfPool.length);
                        roster.push(wolfPool[idx].id);
                        wolfPool.splice(idx, 1);
                    } else if (!bannedIds.has('simple_wolf')) {
                        roster.push('simple_wolf');
                    }
                    currentWolves++;
                }

                const specialPool = ROLES.filter(r => r.type !== 'WOLF' && r.id !== 'white_wolf' && r.id !== 'simple_villager' && r.id !== 'lovers' && !bannedIds.has(r.id) && !roster.includes(r.id));
                let specialCount = Math.floor((playerCount - roster.length) * (difficulty === 'FACILE' ? 0.3 : 0.7));

                while (specialCount > 0 && specialPool.length > 0 && roster.length < playerCount) {
                    const idx = Math.floor(Math.random() * specialPool.length);
                    const role = specialPool[idx];
                    if (role.id === 'sisters') {
                        if (playerCount - roster.length >= 2) {
                            roster.push('sisters', 'sisters');
                            specialCount -= 2;
                        }
                    } else {
                        roster.push(role.id);
                        specialCount--;
                    }
                    specialPool.splice(idx, 1);
                }

                while (roster.length < playerCount) {
                    roster.push('simple_villager');
                }

                for (let i = roster.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roster[i], roster[j]] = [roster[j], roster[i]];
                }

                setPlayers(roster.map((rid, i) => ({
                    uid: `${i}-${Date.now()}`,
                    roleId: rid,
                    isAlive: true,
                    isLover: false
                })));
                setPhase('REVIEW');
            };

            const startGame = () => {
                setTurn(1);
                setIsDay(false);
                setHistoryLog([]);
                setNightKills([]);
                setWitchUsed({ life: false, death: false });
                setInfectUsed(false);
                setElderLives(2);
                setPowersLost(false);
                
                const hasAngel = players.some(p => p.roleId === 'angel');
                setIsDay(hasAngel);
                
                setPhase('GAME');
                setStoryStep(0);
            };

            // --- GAME LOGIC ---

            const roleAlive = (rid) => players.some(p => p.roleId === rid && p.isAlive);

            const currentSequence = useMemo(() => {
                if (phase !== 'GAME') return [];
                
                const seq = [];
                if (!isDay) {
                    seq.push({ id: 'START_NIGHT', title: "La Nuit", text: "Le village s'endort...", image: "üåô" });
                    
                    if (turn === 1) {
                        if (roleAlive('cupid') && !powersLost) seq.push({ type: 'CUPID', title: "Cupidon", text: "Cupidon se r√©veille. Il d√©signe 2 amoureux.", image: "üíò" });
                        seq.push({ id: 'LOVERS', title: "Les Amoureux", text: "Cupidon se rendort. Les Amoureux se r√©veillent, se reconnaissent et se rendorment.", image: "‚ù§Ô∏è" });
                        if (roleAlive('sisters')) seq.push({ id: 'SISTERS', title: "S≈ìurs", text: "Les S≈ìurs se r√©veillent et se reconnaissent.", image: "üëØ" });
                        if (roleAlive('wild_child')) seq.push({ id: 'WILD_CHILD', title: "Enfant Sauvage", text: "L'Enfant Sauvage choisit son mod√®le.", image: "üë∂" });
                    }

                    if (roleAlive('seer') && !powersLost) seq.push({ id: 'SEER', title: "Voyante", text: "La Voyante se r√©veille. Elle d√©signe un joueur dont elle veut conna√Ætre l'identit√©.", image: "üîÆ" });
                    
                    seq.push({ type: 'WOLVES', title: "Les Loups", text: "La Voyante se rendort. Les Loups-Garous se r√©veillent et choisissent une victime.", image: "üê∫" });
                    
                    if (roleAlive('infect_father') && !infectUsed) seq.push({ type: 'INFECT', title: "L'Infect P√®re", text: "L'Infect P√®re peut transformer la victime.", image: "üßü" });
                    
                    if (roleAlive('white_wolf') && turn % 2 === 0) seq.push({ type: 'WHITE', title: "Loup Blanc", text: "Le Loup Blanc se r√©veille seul. Il peut tuer un loup.", image: "üå´Ô∏è" });
                    
                    if (roleAlive('witch') && !powersLost && (!witchUsed.life || !witchUsed.death)) seq.push({ type: 'WITCH', title: "Sorci√®re", text: "Les Loups se rendorment. La Sorci√®re se r√©veille.", image: "üßô" });
                    
                    if (roleAlive('fox') && !powersLost) seq.push({ id: 'FOX', title: "Renard", text: "Le Renard se r√©veille. Il sonde un groupe de 3 joueurs.", image: "ü¶ä" });
                    
                    if (roleAlive('flute_player')) seq.push({ id: 'FLUTE', title: "Fl√ªte", text: "Le Joueur de Fl√ªte se r√©veille. Il charme 2 joueurs.", image: "üé∂" });

                    seq.push({ id: 'END_NIGHT', title: "Fin Nuit", text: "Tout le monde se rendort...", image: "üí§" });
                } else {
                    seq.push({ type: 'REVEAL', title: "R√©veil", text: "C'est le matin, le village se r√©veille !", image: "‚òÄÔ∏è" });
                    if (roleAlive('bear_tamer') && !powersLost) seq.push({ id: 'BEAR', title: "Montreur d'Ours", text: "Si un loup est voisin du Montreur d'Ours, le MJ grogne.", image: "üêª" });
                    seq.push({ id: 'DEBATE', title: "D√©bat", text: "Le village d√©bat pour trouver les coupables.", image: "üó£Ô∏è" });
                    seq.push({ type: 'VOTE', title: "Vote", text: "Le village vote pour √©liminer un suspect.", image: "‚ö∞Ô∏è" });
                    seq.push({ id: 'END_DAY', title: "Fin Jour", text: "La nuit tombe sur le village...", image: "üåô" });
                }
                return seq;
            }, [phase, isDay, turn, players, powersLost, infectUsed, witchUsed]);

            const nextStep = () => {
                if (storyStep < currentSequence.length - 1) {
                    setStoryStep(s => s + 1);
                } else {
                    if (isDay) {
                        setTurn(t => t + 1);
                        setIsDay(false);
                    } else {
                        setIsDay(true);
                    }
                    setStoryStep(0);
                    setNightKills([]); 
                }
                const container = document.getElementById('story-container');
                if(container) container.scrollTop = 0;
            };

            // --- VIEW RENDERERS ---

            if (phase === 'SETUP') {
                return (
                    <div className="h-full bg-stone-900 overflow-y-auto p-4 pb-24 text-center">
                        <h1 className="text-3xl text-red-600 font-serif uppercase tracking-widest mb-1">Thiercelieux</h1>
                        <p className="text-stone-500 text-xs mb-6">Assistant MJ {VERSION} (Github Pages)</p>
                        
                        <div className="bg-stone-800 p-4 rounded-xl mb-4 border border-stone-700">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-amber-500 font-bold">Joueurs</span>
                                <span className="text-3xl font-serif">{playerCount}</span>
                            </div>
                            <input type="range" min="8" max="28" value={playerCount} onChange={(e) => setPlayerCount(parseInt(e.target.value))} className="w-full accent-red-600" />
                        </div>

                        <div className="flex gap-2 mb-6">
                            {['FACILE', 'MOYENNE', 'DIFFICILE'].map(d => (
                                <button key={d} onClick={() => setDifficulty(d)} className={`flex-1 py-3 rounded text-xs font-bold border border-stone-700 ${difficulty === d ? 'bg-red-700 text-white' : 'bg-stone-800 text-stone-500'}`}>
                                    {d}
                                </button>
                            ))}
                        </div>

                        <div className="grid grid-cols-3 gap-2">
                            {ROLES.filter(r => r.id !== 'lovers').map(r => {
                                const s = roleStatus[r.id] || 'NEUTRAL';
                                const bgCls = s === 'BANNED' ? 'bg-red-900/20 border-red-900' : s === 'REQUIRED' ? 'bg-green-900/20 border-green-600' : '';
                                return (
                                    <div key={r.id} onClick={() => cycleRoleStatus(r.id)} className={`relative bg-stone-800 p-2 rounded border border-stone-700 flex flex-col items-center gap-1 ${bgCls}`}>
                                        <RoleImg rid={r.id} />
                                        <span className="text-[9px] font-bold leading-tight">{r.name}</span>
                                        {s === 'BANNED' && <div className="banned-cross">X</div>}
                                        {s === 'REQUIRED' && <div className="required-dot"></div>}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-stone-950">
                            <button onClick={generateGame} className="w-full py-4 bg-red-700 text-white font-serif text-2xl font-bold rounded-xl shadow-xl">G√âN√âRER</button>
                        </div>
                    </div>
                );
            }

            if (phase === 'REVIEW') {
                return (
                    <div className="h-full bg-stone-900 p-4 flex flex-col">
                        <h2 className="text-2xl text-amber-500 font-serif text-center mb-6">Casting du Village</h2>
                        <div className="flex-1 overflow-y-auto grid grid-cols-4 gap-2 content-start">
                            {players.map(p => (
                                <div key={p.uid} className="bg-stone-800 p-2 rounded flex flex-col items-center border border-stone-700">
                                    <RoleImg rid={p.roleId} size="w-8 h-8" />
                                    <span className="text-[9px] text-center mt-1 text-stone-300 leading-tight">{getRole(p.roleId).name}</span>
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-4 mt-4">
                            <button onClick={() => setPhase('SETUP')} className="flex-1 py-3 bg-stone-700 rounded text-stone-300 font-bold">Modifier</button>
                            <button onClick={startGame} className="flex-1 py-3 bg-green-700 text-white font-bold rounded shadow-lg">Lancer !</button>
                        </div>
                    </div>
                );
            }

            if (phase === 'VICTORY') {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-stone-900 text-center p-6 fade-in">
                        <div className="text-6xl mb-4">üèÜ</div>
                        <h1 className="text-4xl font-serif text-amber-500 font-bold mb-2">VICTOIRE</h1>
                        <h2 className="text-2xl font-bold mb-6">{victory.winner}</h2>
                        <p className="text-stone-400 mb-10">{victory.reason}</p>
                        <button onClick={() => setPhase('SETUP')} className="px-8 py-3 bg-stone-700 rounded-lg font-bold">Nouvelle Partie</button>
                    </div>
                );
            }

            // --- GAME RENDER ---
            
            const step = currentSequence[storyStep];
            if (!step) return <div>Chargement...</div>;

            return (
                <div className="h-full bg-stone-950 flex flex-col relative">
                    {/* HEADER */}
                    <div className="h-16 flex items-center justify-between px-4 bg-stone-900 border-b border-stone-800">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{isDay ? '‚òÄÔ∏è' : 'üåô'}</span>
                            <div className="leading-none">
                                <div className="text-[10px] text-stone-500 font-bold uppercase tracking-wider">{isDay ? 'JOURN√âE' : 'NUIT'} {turn}</div>
                                <div className="text-amber-500 font-serif text-lg">{step.title}</div>
                            </div>
                        </div>
                        <button onClick={() => { if(confirm('Quitter ?')) setPhase('SETUP'); }} className="text-2xl text-stone-600 hover:text-white">X</button>
                    </div>

                    {/* STORY CONTAINER */}
                    <div id="story-container" className="flex-1 overflow-y-auto p-6 flex flex-col items-center bg-[url('https://www.transparenttextures.com/patterns/black-paper.png')]">
                        <div className="w-full max-w-md fade-in">
                            <p className="text-xl text-stone-300 text-center font-serif italic mb-8 leading-relaxed">"{step.text}"</p>
                            
                            {/* DYNAMIC CONTENT */}
                            {step.type === 'CUPID' && (
                                <>
                                    <p className="text-center text-stone-400 text-sm mb-2">
                                        S√©lectionnez 2 amoureux ({players.filter(p => p.isLover).length}/2)
                                    </p>
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {players.filter(p => p.isAlive).map(p => (
                                            <div key={p.uid} onClick={() => {
                                                const newPlayers = [...players];
                                                const target = newPlayers.find(x => x.uid === p.uid);
                                                const count = newPlayers.filter(x => x.isLover).length;
                                                
                                                if(target.isLover) {
                                                    target.isLover = false; // Toggle OFF
                                                } else if(count < 2) {
                                                    target.isLover = true; // Toggle ON (max 2)
                                                }
                                                setPlayers(newPlayers);
                                            }} className={`p-2 rounded flex flex-col items-center transition-all cursor-pointer ${p.isLover ? 'bg-pink-900 border border-pink-500 ring-2 ring-pink-500' : 'bg-stone-800 border border-stone-700 opacity-80'}`}>
                                                <RoleImg rid={p.roleId} size="w-8 h-8" />
                                            </div>
                                        ))}
                                    </div>
                                    <button 
                                        onClick={nextStep} 
                                        disabled={players.filter(p => p.isLover).length !== 2}
                                        className="w-full py-3 bg-pink-700 rounded font-bold disabled:opacity-50 disabled:bg-stone-800"
                                    >
                                        Valider le Couple
                                    </button>
                                </>
                            )}

                            {(step.type === 'WOLVES' || step.type === 'WHITE' || step.type === 'VOTE') && (
                                <>
                                    <p className="text-center text-stone-400 text-sm mb-4">Cliquez pour √©liminer</p>
                                    <div className="grid grid-cols-4 gap-2">
                                        {players.filter(p => p.isAlive && (step.type !== 'WHITE' || getRole(p.roleId).type === 'WOLF')).map(p => (
                                            <div key={p.uid} onClick={() => {
                                                if(confirm(`Tuer ${getRole(p.roleId).name} ?`)) {
                                                    if (step.type === 'VOTE') {
                                                        killPlayer(p.uid, 'Vote du Village');
                                                        nextStep();
                                                    } else {
                                                        // Nuit
                                                        if (p.roleId === 'elder' && elderLives > 1 && !isDay) {
                                                            setElderLives(l => l - 1);
                                                            alert("L'Ancien a surv√©cu !");
                                                            log("L'Ancien a surv√©cu √† une attaque.");
                                                        } else {
                                                            setNightKills(prev => [...prev, p.uid]);
                                                            log(`Attaque sur ${getRole(p.roleId).name}`);
                                                        }
                                                        nextStep();
                                                    }
                                                }
                                            }} className="p-2 bg-stone-800 border border-stone-700 rounded flex flex-col items-center active:scale-95 transition-transform">
                                                <RoleImg rid={p.roleId} />
                                                <span className="text-[9px] mt-1">{getRole(p.roleId).name}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={nextStep} className="mt-6 text-stone-500 underline text-sm block mx-auto">Personne ne meurt</button>
                                </>
                            )}

                            {step.type === 'INFECT' && (() => {
                                const vicId = nightKills[nightKills.length - 1];
                                const victim = players.find(p => p.uid === vicId);
                                if (!victim) return (
                                    <>
                                        <p className="text-center italic text-stone-500 mb-6 bg-stone-800/50 p-4 rounded">Aucune victime √† infecter cette nuit.</p>
                                        <button onClick={nextStep} className="w-full py-3 bg-stone-700 rounded font-bold">Passer</button>
                                    </>
                                );
                                return (
                                    <>
                                        <div className="bg-red-900/30 p-4 rounded border border-red-900 mb-6 text-center">
                                            <p className="text-red-400 text-xs uppercase font-bold">Victime</p>
                                            <div className="flex items-center justify-center gap-2 mt-2">
                                                <RoleImg rid={victim.roleId} />
                                                <span className="text-xl font-serif">{getRole(victim.roleId).name}</span>
                                            </div>
                                        </div>
                                        <button onClick={() => {
                                            const newPlayers = players.map(p => p.uid === vicId ? { ...p, roleId: 'simple_wolf', isAlive: true } : p);
                                            setPlayers(newPlayers);
                                            setNightKills(prev => prev.filter(id => id !== vicId));
                                            setInfectUsed(true);
                                            log("üê∫ L'Infect P√®re a transform√© une victime en Loup !");
                                            nextStep();
                                        }} className="w-full py-4 bg-green-800 mb-3 rounded font-bold border border-green-600 shadow-lg">üßü Infecter (Devient Loup)</button>
                                        <button onClick={nextStep} className="w-full py-4 bg-red-900 rounded font-bold border border-red-800 opacity-80">‚ò†Ô∏è Laisser Mourir</button>
                                    </>
                                );
                            })()}

                            {step.type === 'WITCH' && (() => {
                                const vicId = nightKills[nightKills.length - 1];
                                const victim = players.find(p => p.uid === vicId);
                                return (
                                    <>
                                        <div className="mb-4 text-center">
                                            {victim ? (
                                                <div className="inline-flex items-center gap-2 bg-stone-800 p-2 rounded border border-red-900">
                                                    <span className="text-red-500 text-xs">Victime:</span> 
                                                    <RoleImg rid={victim.roleId} size="w-6 h-6" />
                                                </div>
                                            ) : <span className="text-stone-500 italic">Aucune victime</span>}
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                            <button 
                                                onClick={() => {
                                                    setNightKills(prev => prev.filter(id => id !== vicId));
                                                    setWitchUsed(prev => ({ ...prev, life: true }));
                                                    log("La Sorci√®re a utilis√© la potion de VIE.");
                                                    nextStep();
                                                }}
                                                disabled={!victim || witchUsed.life}
                                                className="p-3 bg-green-800 rounded font-bold border border-green-600 disabled:opacity-50"
                                            >üß™ Sauver</button>
                                            <button 
                                                id="btn-witch-kill"
                                                onClick={(e) => {
                                                    e.target.style.display='none';
                                                    document.getElementById('witch-kill-grid').style.display='grid';
                                                }}
                                                disabled={witchUsed.death}
                                                className="p-3 bg-purple-800 rounded font-bold border border-purple-600 disabled:opacity-50"
                                            >‚ò†Ô∏è Tuer</button>
                                        </div>
                                        <div id="witch-kill-grid" className="hidden grid-cols-4 gap-2 mb-4 bg-stone-800 p-2 rounded">
                                            {players.filter(p => p.isAlive && p.uid !== vicId).map(p => (
                                                <div key={p.uid} onClick={() => {
                                                    setNightKills(prev => [...prev, p.uid]);
                                                    setWitchUsed(prev => ({ ...prev, death: true }));
                                                    log("La Sorci√®re a utilis√© la potion de MORT.");
                                                    nextStep();
                                                }} className="flex flex-col items-center">
                                                    <RoleImg rid={p.roleId} size="w-8 h-8" />
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={nextStep} className="w-full py-3 bg-stone-700 rounded text-stone-300">Ne rien faire</button>
                                    </>
                                );
                            })()}

                            {step.type === 'REVEAL' && (
                                <>
                                    <div className="bg-stone-800 p-4 rounded mb-6 text-center">
                                        {nightKills.length === 0 ? <p className="text-green-500 font-bold">Le village se r√©veille complet !</p> : (
                                            <div>
                                                <p className="text-red-500 mb-2 font-bold">Morts cette nuit :</p>
                                                {nightKills.map(uid => {
                                                    const p = players.find(x => x.uid === uid);
                                                    if (p.isAlive) killPlayer(uid, 'Nuit'); // Commit death
                                                    return (
                                                        <div key={uid} className="flex items-center justify-center gap-2 mb-1">
                                                            <RoleImg rid={p.roleId} size="w-6 h-6" /> 
                                                            {getRole(p.roleId).name}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={nextStep} className="w-full py-4 bg-amber-600 font-bold rounded shadow text-xl">Continuer</button>
                                </>
                            )}

                            {!step.type && !step.id && (
                                <>
                                    <div className="text-8xl mb-6 text-center animate-bounce-slow">{step.image}</div>
                                    <button onClick={nextStep} className="w-full py-4 bg-amber-700 hover:bg-amber-600 text-white font-serif font-bold text-xl rounded-lg shadow-xl">SUIVANT</button>
                                </>
                            )}

                            {!step.type && step.id && (
                                <>
                                    <div className="text-8xl mb-6 text-center animate-bounce-slow">{step.image}</div>
                                    <button onClick={nextStep} className="w-full py-4 bg-amber-700 hover:bg-amber-600 text-white font-serif font-bold text-xl rounded-lg shadow-xl">SUIVANT</button>
                                </>
                            )}

                        </div>
                    </div>

                    {/* FOOTER / LOGS */}
                    <div className="h-40 bg-stone-900 border-t border-stone-800 flex flex-col">
                        <div className="flex-1 overflow-y-auto p-2 font-mono text-[10px] text-stone-500 space-y-1">
                            {historyLog.map((l, i) => <div key={i} className="border-l border-stone-700 pl-2">{l}</div>)}
                        </div>
                        <div className="flex border-t border-stone-800">
                            <button onClick={() => setShowDashboard(true)} className="flex-1 py-3 bg-stone-800 text-amber-500 font-bold flex items-center justify-center gap-2"><span>üë•</span> Village (God Mode)</button>
                        </div>
                    </div>

                    {/* DASHBOARD OVERLAY */}
                    {showDashboard && (
                        <div className="absolute inset-0 bg-stone-950/95 z-50 flex flex-col p-4">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-serif text-amber-500">√âtat du Village</h2>
                                <button onClick={() => setShowDashboard(false)} className="text-3xl">X</button>
                            </div>
                            <div className="flex-1 overflow-y-auto grid grid-cols-3 gap-2 content-start">
                                {players.map(p => (
                                    <div key={p.uid} onClick={() => p.isAlive ? killPlayer(p.uid, 'MJ') : revivePlayer(p.uid)} className={`p-2 border rounded flex flex-col items-center text-center cursor-pointer ${p.isAlive ? 'border-stone-600 bg-stone-800' : 'border-red-900 bg-red-900/20 opacity-60'}`}>
                                        <RoleImg rid={p.roleId} />
                                        <span className="text-[9px] font-bold mt-1 text-stone-300">{getRole(p.roleId).name}</span>
                                        <span className={`text-[8px] px-1 rounded ${p.isAlive ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'}`}>{p.isAlive ? 'VIVANT' : 'MORT'}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>