<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loups-Garous Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1c1917; color: white; overflow: hidden; }
        h1, h2, h3, .font-serif { font-family: 'Crimson Text', serif; }
        .banned-cross { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: #ef4444; font-size: 3rem; font-weight: bold; pointer-events: none; }
        .required-dot { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; box-shadow: 0 0 5px #22c55e; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1c1917; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script>
        // Mouchard d'erreurs global
        window.onerror = function(msg, url, line, col, error) {
            const app = document.getElementById('app');
            if (app) {
                app.innerHTML = `
                    <div class="p-6 bg-red-900 text-white h-screen flex flex-col justify-center items-center text-center">
                        <h1 class="text-3xl mb-4">üòµ Oups !</h1>
                        <p class="font-bold text-xl mb-2">Une erreur est survenue (v2.2)</p>
                        <div class="bg-black p-4 rounded text-left font-mono text-xs overflow-auto w-full max-w-md border border-red-500">
                            <p class="text-red-300">Message : ${msg}</p>
                            <p class="text-stone-400">Ligne : ${line}</p>
                            <p class="text-stone-500 mt-2">${error ? error.stack : ''}</p>
                        </div>
                        <button onclick="location.reload()" class="mt-8 px-6 py-3 bg-white text-red-900 font-bold rounded">R√©essayer</button>
                    </div>
                `;
            }
            return false;
        };
    </script>
</head>
<body>
    <div id="app" class="h-screen flex flex-col">
        <div class="flex-1 flex flex-col items-center justify-center text-stone-500 gap-4">
            <div class="animate-spin text-4xl">‚è≥</div>
            <div>Chargement v2.2 (Corrective)...</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log("App v2.2 Initializing...");

                // --- DATA ---
                const ROLES = [
                  { id: 'cupid', name: 'Cupidon', type: 'VILLAGER', imageSrc: 'images/v-cupidon.png' },
                  { id: 'lovers', name: 'Les Amoureux', type: 'SPECIAL', imageSrc: 'images/v-cupidon.png' },
                  { id: 'seer', name: 'La Voyante', type: 'VILLAGER', imageSrc: 'images/v-voyante.png' },
                  { id: 'simple_wolf', name: 'Simple Loup-Garou', type: 'WOLF', imageSrc: 'images/l-simple.png' },
                  { id: 'infect_father', name: 'Infect P√®re des Loups', type: 'WOLF', imageSrc: 'images/l-infect.png' },
                  { id: 'big_bad_wolf', name: 'Grand M√©chant Loup', type: 'WOLF', imageSrc: 'images/l-grand.png' },
                  { id: 'witch', name: 'La Sorci√®re', type: 'VILLAGER', imageSrc: 'images/v-sorciere.png' },
                  { id: 'hunter', name: 'Le Chasseur', type: 'VILLAGER', imageSrc: 'images/v-chasseur.png' },
                  { id: 'sisters', name: 'Les Deux S≈ìurs', type: 'VILLAGER', imageSrc: 'images/v-soeurs.png' },
                  { id: 'little_girl', name: 'La Petite Fille', type: 'VILLAGER', imageSrc: 'images/v-petitefille.png' },
                  { id: 'fox', name: 'Le Renard', type: 'VILLAGER', imageSrc: 'images/v-renard.png' },
                  { id: 'rusty_knight', name: 'Chevalier √âp√©e Rouill√©e', type: 'VILLAGER', imageSrc: 'images/v-chevalier.png' },
                  { id: 'elder', name: "L'Ancien", type: 'VILLAGER', imageSrc: 'images/v-ancien.png' },
                  { id: 'bear_tamer', name: "Montreur d'Ours", type: 'VILLAGER', imageSrc: 'images/v-ours.png' },
                  { id: 'simple_villager', name: 'Simple Villageois', type: 'VILLAGER', imageSrc: 'images/v-simple.png' },
                  { id: 'wild_child', name: 'Enfant Sauvage', type: 'AMBIGUOUS', imageSrc: 'images/a-enfantsauvage.png' },
                  { id: 'dog_wolf', name: 'Chien-Loup', type: 'AMBIGUOUS', imageSrc: 'images/a-chienloup.png' },
                  { id: 'white_wolf', name: 'Loup-Garou Blanc', type: 'LONER', imageSrc: 'images/s-lgblanc.png' },
                  { id: 'flute_player', name: 'Joueur de Fl√ªte', type: 'LONER', imageSrc: 'images/s-flute.png' },
                  { id: 'angel', name: "L'Ange", type: 'LONER', imageSrc: 'images/s-ange.png' }
                ];

                // --- STATE ---
                let state = {
                    phase: 'SETUP',
                    playerCount: 8,
                    difficulty: 'MOYENNE',
                    roleStatus: {},
                    players: [],
                    turn: 1,
                    isDay: false,
                    historyLog: [],
                    storyStep: 0,
                    currentSequence: [],
                    nightKills: [],
                    witchUsed: { life: false, death: false },
                    infectUsed: false,
                    elderLives: 2,
                    powersLost: false,
                    showDashboard: false,
                    victory: null
                };

                // --- CORE LOGIC ---
                window.log = function(text) {
                    state.historyLog.unshift(`[${state.isDay ? 'Jour' : 'Nuit'} ${state.turn}] ${text}`);
                    render();
                };

                window.getRole = function(id) { return ROLES.find(r => r.id === id); };

                window.killPlayer = function(uid, reason) {
                    const p = state.players.find(x => x.uid === uid);
                    if (!p || !p.isAlive) return;
                    
                    p.isAlive = false;
                    const r = getRole(p.roleId);

                    // Mal√©diction de l'Ancien
                    if (p.roleId === 'elder' && reason === "Vote du Village") {
                        state.powersLost = true;
                        log("üíÄ L'Ancien est mort par le vote ! Les pouvoirs sont perdus !");
                    } else {
                        log(`${r.name} est mort (${reason}).`);
                    }

                    // Amoureux
                    if (p.isLover) {
                        const lover = state.players.find(x => x.isLover && x.uid !== uid && x.isAlive);
                        if (lover) {
                            const lr = getRole(lover.roleId);
                            lover.isAlive = false;
                            log(`üíî ${lr.name} meurt de chagrin !`);
                        }
                    }
                    // Chasseur
                    if (p.roleId === 'hunter') {
                        alert("LE CHASSEUR EST MORT ! IL DOIT TIRER !");
                        log("üî´ Le Chasseur tire avant de mourir.");
                    }
                    checkVictory();
                    render();
                };

                window.revivePlayer = function(uid) {
                    const p = state.players.find(x => x.uid === uid);
                    if (p) {
                        p.isAlive = true;
                        log(`‚ú® ${getRole(p.roleId).name} a √©t√© ressuscit√©.`);
                        render();
                    }
                };

                window.checkVictory = function() {
                    const alive = state.players.filter(p => p.isAlive);
                    const wolves = alive.filter(p => getRole(p.roleId).type === 'WOLF' || p.roleId === 'white_wolf');
                    const villagers = alive.filter(p => getRole(p.roleId).type !== 'WOLF' && p.roleId !== 'white_wolf' && p.roleId !== 'flute_player' && p.roleId !== 'angel');
                    const lovers = alive.filter(p => p.isLover);
                    const angel = state.players.find(p => p.roleId === 'angel');

                    let win = null;
                    if (angel && !angel.isAlive && state.turn === 1 && state.isDay) win = { winner: "L'Ange", reason: "Il a r√©ussi son suicide !" };
                    else if (lovers.length === 2 && alive.length === 2) win = { winner: "Les Amoureux", reason: "Seuls au monde." };
                    else if (wolves.length === 1 && wolves[0].roleId === 'white_wolf' && villagers.length === 0) win = { winner: "Le Loup Blanc", reason: "Le dernier survivant." };
                    else if (wolves.length > 0 && villagers.length === 0) win = { winner: "Les Loups", reason: "Le village est d√©vor√©." };
                    else if (wolves.length === 0 && villagers.length > 0) win = { winner: "Les Villageois", reason: "Les loups sont √©limin√©s." };

                    if (win) {
                        state.victory = win;
                        state.phase = 'VICTORY';
                    }
                };

                // --- GENERATOR ---
                window.generateGame = function() {
                    let roster = [];
                    const required = ROLES.filter(r => state.roleStatus[r.id] === 'REQUIRED');
                    const bannedIds = new Set(ROLES.filter(r => state.roleStatus[r.id] === 'BANNED').map(r => r.id));
                    bannedIds.add('lovers');

                    required.forEach(r => {
                        if (r.id !== 'lovers') {
                            roster.push(r.id);
                            if (r.id === 'sisters') roster.push(r.id);
                        }
                    });

                    if (roster.length > state.playerCount) { alert("Trop de r√¥les requis !"); return; }

                    const maxWolves = Math.max(1, Math.floor(state.playerCount / 4));
                    let currentWolves = roster.filter(rid => getRole(rid)?.type === 'WOLF').length;
                    const wolfPool = ROLES.filter(r => (r.type === 'WOLF' || r.id === 'white_wolf') && !bannedIds.has(r.id) && !roster.includes(r.id));

                    while (currentWolves < maxWolves && roster.length < state.playerCount) {
                        if (wolfPool.length > 0 && Math.random() < (state.difficulty === 'FACILE' ? 0.2 : 0.6)) {
                            const idx = Math.floor(Math.random() * wolfPool.length);
                            roster.push(wolfPool[idx].id);
                            wolfPool.splice(idx, 1);
                        } else if (!bannedIds.has('simple_wolf')) {
                            roster.push('simple_wolf');
                        }
                        currentWolves++;
                    }

                    const specialPool = ROLES.filter(r => r.type !== 'WOLF' && r.id !== 'white_wolf' && r.id !== 'simple_villager' && r.id !== 'lovers' && !bannedIds.has(r.id) && !roster.includes(r.id));
                    let specialCount = Math.floor((state.playerCount - roster.length) * (state.difficulty === 'FACILE' ? 0.3 : 0.7));

                    while (specialCount > 0 && specialPool.length > 0 && roster.length < state.playerCount) {
                        const idx = Math.floor(Math.random() * specialPool.length);
                        const role = specialPool[idx];
                        if (role.id === 'sisters') {
                            if (state.playerCount - roster.length >= 2) { roster.push('sisters', 'sisters'); specialCount -= 2; }
                        } else {
                            roster.push(role.id);
                            specialCount--;
                        }
                        specialPool.splice(idx, 1);
                    }

                    while (roster.length < state.playerCount) roster.push('simple_villager');
                    
                    for (let i = roster.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [roster[i], roster[j]] = [roster[j], roster[i]];
                    }

                    state.players = roster.map((rid, i) => ({ uid: i + '-' + Date.now(), roleId: rid, isAlive: true, isLover: false }));
                    state.phase = 'REVIEW';
                    render();
                };

                // --- SEQUENCE ---
                window.roleAlive = function(rid) { return state.players.some(p => p.roleId === rid && p.isAlive); };

                window.buildSequences = function(t) {
                    const seq = [];
                    if (!state.isDay) {
                        seq.push({ id: 'START', title: "La Nuit", text: "Le village s'endort...", image: "üåô" });
                        if (t === 1 && roleAlive('cupid')) seq.push({ type: 'CUPID', title: "Cupidon", text: "Cupidon se r√©veille. Il d√©signe 2 amoureux.", image: "üíò" });
                        if (t === 1) seq.push({ id: 'LOVERS', title: "Les Amoureux", text: "Cupidon se rendort. Les Amoureux se r√©veillent et se reconnaissent.", image: "‚ù§Ô∏è" });
                        if (roleAlive('seer') && !state.powersLost) seq.push({ id: 'SEER', title: "Voyante", text: "La Voyante se r√©veille. Elle d√©signe un joueur dont elle veut conna√Ætre l'identit√©.", image: "üîÆ" });
                        seq.push({ type: 'WOLVES', title: "Les Loups", text: "La Voyante se rendort. Les Loups-Garous se r√©veillent et choisissent une victime.", image: "üê∫" });
                        if (roleAlive('infect_father') && !state.infectUsed) seq.push({ type: 'INFECT', title: "L'Infect P√®re", text: "L'Infect P√®re peut transformer la victime.", image: "üßü" });
                        if (roleAlive('white_wolf') && t % 2 === 0) seq.push({ type: 'WHITE', title: "Loup Blanc", text: "Le Loup Blanc se r√©veille seul. Il peut tuer un loup.", image: "üå´Ô∏è" });
                        if (roleAlive('witch') && !state.powersLost && (!state.witchUsed.life || !state.witchUsed.death)) seq.push({ type: 'WITCH', title: "Sorci√®re", text: "Les Loups se rendorment. La Sorci√®re se r√©veille.", image: "üßô" });
                        if (roleAlive('fox') && !state.powersLost) seq.push({ id: 'FOX', title: "Renard", text: "Le Renard se r√©veille. Il sonde un groupe de 3 joueurs.", image: "ü¶ä" });
                        if (roleAlive('flute_player')) seq.push({ id: 'FLUTE', title: "Fl√ªte", text: "Le Joueur de Fl√ªte se r√©veille. Il charme 2 joueurs.", image: "üé∂" });
                        seq.push({ id: 'END_NIGHT', title: "Fin Nuit", text: "Tout le monde se rendort...", image: "üí§" });
                    } else {
                        seq.push({ type: 'REVEAL', title: "R√©veil", text: "C'est le matin, le village se r√©veille !", image: "‚òÄÔ∏è" });
                        seq.push({ id: 'DEBATE', title: "D√©bat", text: "Le village d√©bat pour trouver les coupables.", image: "üó£Ô∏è" });
                        seq.push({ type: 'VOTE', title: "Vote", text: "Le village vote pour √©liminer un suspect.", image: "‚ö∞Ô∏è" });
                        seq.push({ id: 'END_DAY', title: "Fin Jour", text: "La nuit tombe sur le village...", image: "üåô" });
                    }
                    return seq;
                };

                window.nextStep = function() {
                    if (state.storyStep < state.currentSequence.length - 1) {
                        state.storyStep++;
                    } else {
                        if (state.isDay) {
                            state.turn++;
                            state.isDay = false;
                        } else {
                            state.isDay = true;
                        }
                        state.storyStep = 0;
                        state.currentSequence = buildSequences(state.turn);
                        state.nightKills = [];
                    }
                    render();
                };

                // --- RENDERERS ---
                window.RoleImg = function(rid, size) {
                    if (!size) size = 'w-12 h-12';
                    const r = getRole(rid);
                    if (!r) return '';
                    // Utilisation de guillemets simples pour √©viter les conflits dans les cha√Ænes HTML
                    return `<div class='flex flex-col items-center'>
                        <img src='${r.imageSrc}' class='${size} object-contain drop-shadow-md' onerror='this.style.display="none";this.nextElementSibling.style.display="flex"'>
                        <div class='${size} bg-stone-700 rounded-full flex items-center justify-center border border-stone-500 hidden text-xs font-bold text-white'>${r.name.substr(0,2)}</div>
                    </div>`;
                };

                window.renderSetup = function() {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                        <div class="h-full bg-stone-900 overflow-y-auto p-4 pb-24 text-center">
                            <h1 class="text-3xl text-red-600 font-serif uppercase tracking-widest mb-1">Thiercelieux</h1>
                            <p class="text-stone-500 text-xs mb-6">Assistant MJ v2.2 (Corrective)</p>
                            
                            <div class="bg-stone-800 p-4 rounded-xl mb-4 border border-stone-700">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-amber-500 font-bold">Joueurs</span>
                                    <span class="text-3xl font-serif">${state.playerCount}</span>
                                </div>
                                <input type="range" min="8" max="28" value="${state.playerCount}" oninput="state.playerCount=parseInt(this.value);render()" class="w-full accent-red-600">
                            </div>

                            <div class="flex gap-2 mb-6">
                                ${['FACILE', 'MOYENNE', 'DIFFICILE'].map(d => 
                                    `<button onclick="state.difficulty='${d}';render()" class="flex-1 py-3 rounded text-xs font-bold border border-stone-700 ${state.difficulty===d ? 'bg-red-700 text-white' : 'bg-stone-800 text-stone-500'}">${d}</button>`
                                ).join('')}
                            </div>

                            <div class="grid grid-cols-3 gap-2">
                                ${ROLES.filter(r => r.id !== 'lovers').map(r => {
                                    const s = state.roleStatus[r.id] || 'NEUTRAL';
                                    return `
                                        <div onclick="cycleRoleStatus('${r.id}')" class="relative bg-stone-800 p-2 rounded border border-stone-700 flex flex-col items-center gap-1 ${s==='BANNED'?'bg-red-900/20 border-red-900':s==='REQUIRED'?'bg-green-900/20 border-green-600':''}">
                                            ${RoleImg(r.id)}
                                            <span class="text-[9px] font-bold leading-tight">${r.name}</span>
                                            ${s==='BANNED' ? '<div class="banned-cross">√ó</div>' : ''}
                                            ${s==='REQUIRED' ? '<div class="required-dot"></div>' : ''}
                                        </div>
                                    `
                                }).join('')}
                            </div>

                            <div class="fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-stone-950">
                                <button onclick="generateGame()" class="w-full py-4 bg-red-700 text-white font-serif text-2xl font-bold rounded-xl shadow-xl">G√âN√âRER</button>
                            </div>
                        </div>
                    `;
                };

                window.cycleRoleStatus = function(rid) {
                    const s = state.roleStatus[rid] || 'NEUTRAL';
                    state.roleStatus[rid] = s === 'NEUTRAL' ? 'BANNED' : s === 'BANNED' ? 'REQUIRED' : 'NEUTRAL';
                    render();
                };

                window.renderReview = function() {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                        <div class="h-full bg-stone-900 p-4 flex flex-col">
                            <h2 class="text-2xl text-amber-500 font-serif text-center mb-6">Casting du Village</h2>
                            <div class="flex-1 overflow-y-auto grid grid-cols-4 gap-2 content-start">
                                ${state.players.map(p => `
                                    <div class="bg-stone-800 p-2 rounded flex flex-col items-center border border-stone-700">
                                        ${RoleImg(p.roleId, 'w-8 h-8')}
                                        <span class="text-[9px] text-center mt-1 text-stone-300 leading-tight">${getRole(p.roleId).name}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex gap-4 mt-4">
                                <button onclick="state.phase='SETUP';render()" class="flex-1 py-3 bg-stone-700 rounded text-stone-300 font-bold">Modifier</button>
                                <button onclick="startGame()" class="flex-1 py-3 bg-green-700 text-white font-bold rounded shadow-lg">Lancer !</button>
                            </div>
                        </div>
                    `;
                };

                window.startGame = function() {
                    state.phase = 'GAME';
                    state.turn = 1;
                    state.isDay = false;
                    state.historyLog = [];
                    state.nightKills = [];
                    state.witchUsed = {life:false, death:false};
                    state.infectUsed = false;
                    state.elderLives = 2;
                    state.powersLost = false;
                    
                    if (state.players.some(p => p.roleId === 'angel')) state.isDay = true;
                    state.currentSequence = buildSequences(state.turn);
                    state.storyStep = 0;
                    render();
                };

                window.renderGame = function() {
                    const app = document.getElementById('app');
                    const step = state.currentSequence[state.storyStep];
                    if (!step) return;

                    let contentHtml = '';

                    // --- STEP LOGIC ---
                    if (step.type === 'CUPID') {
                        const lovers = state.players.filter(p => p.isLover);
                        contentHtml = `
                            <p class="text-center text-stone-400 text-sm mb-2">S√©lectionnez 2 amoureux (${lovers.length}/2)</p>
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                ${state.players.filter(p => p.isAlive).map(p => `
                                    <div onclick="toggleLover('${p.uid}')" class="p-2 rounded flex flex-col items-center transition-all ${p.isLover ? 'bg-pink-900 border border-pink-500' : 'bg-stone-800 border border-stone-700'}">
                                        ${RoleImg(p.roleId, 'w-8 h-8')}
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="nextStep()" ${lovers.length !== 2 ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''} class="w-full py-3 bg-pink-700 rounded font-bold">Valider le Couple</button>
                        `;
                    } else if (step.type === 'WOLVES' || step.type === 'WHITE' || step.type === 'VOTE') {
                        // Kill Selection
                        const isWhite = step.type === 'WHITE';
                        const isVote = step.type === 'VOTE';
                        contentHtml = `
                            <p class="text-center text-stone-400 text-sm mb-4">Cliquez pour √©liminer</p>
                            <div class="grid grid-cols-4 gap-2">
                                ${state.players.filter(p => p.isAlive && (!isWhite || getRole(p.roleId).type === 'WOLF')).map(p => `
                                    <div onclick="confirmKill('${p.uid}', '${isVote ? 'Vote du Village' : 'Nuit'}')" class="p-2 bg-stone-800 border border-stone-700 rounded flex flex-col items-center active:scale-95 transition-transform">
                                        ${RoleImg(p.roleId)}
                                        <span class="text-[9px] mt-1">${getRole(p.roleId).name}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="nextStep()" class="mt-6 text-stone-500 underline text-sm">Personne ne meurt</button>
                        `;
                    } else if (step.type === 'INFECT') {
                        const vicId = state.nightKills[state.nightKills.length-1];
                        const victim = state.players.find(p => p.uid === vicId);
                        
                        if (!victim) {
                            contentHtml = `<p class="text-center italic text-stone-500 mb-6">Aucune proie √† infecter cette nuit.</p><button onclick="nextStep()" class="w-full py-3 bg-stone-700 rounded">Suivant</button>`;
                        } else {
                            contentHtml = `
                                <div class="bg-red-900/30 p-4 rounded border border-red-900 mb-6 text-center">
                                    <p class="text-red-400 text-xs uppercase font-bold">Victime</p>
                                    <div class="flex items-center justify-center gap-2 mt-2">
                                        ${RoleImg(victim.roleId)}
                                        <span class="text-xl font-serif">${getRole(victim.roleId).name}</span>
                                    </div>
                                </div>
                                <button onclick="infectVictim('${vicId}')" class="w-full py-4 bg-green-800 mb-3 rounded font-bold border border-green-600">üßü Infecter (Devient Loup)</button>
                                <button onclick="nextStep()" class="w-full py-4 bg-red-900 rounded font-bold border border-red-800">‚ò†Ô∏è Laisser Mourir</button>
                            `;
                        }
                    } else if (step.type === 'WITCH') {
                        const vicId = state.nightKills[state.nightKills.length-1];
                        const victim = state.players.find(p => p.uid === vicId);
                        contentHtml = `
                            <div class="mb-4 text-center">
                                ${victim ? `<div class="inline-flex items-center gap-2 bg-stone-800 p-2 rounded border border-red-900"><span class="text-red-500 text-xs">Victime:</span> ${RoleImg(victim.roleId, 'w-6 h-6')}</div>` : '<span class="text-stone-500 italic">Aucune victime</span>'}
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <button onclick="witchHeal('${vicId}')" ${(!victim || state.witchUsed.life) ? 'disabled style="opacity:0.5"' : ''} class="p-3 bg-green-800 rounded font-bold border border-green-600">üß™ Sauver</button>
                                <button onclick="this.disabled=true;document.getElementById('witch-kill').style.display='grid'" ${state.witchUsed.death ? 'disabled style="opacity:0.5"' : ''} class="p-3 bg-purple-800 rounded font-bold border border-purple-600">‚ò†Ô∏è Tuer</button>
                            </div>
                            <div id="witch-kill" class="hidden grid-cols-4 gap-2 mb-4 bg-stone-800 p-2 rounded">
                                ${state.players.filter(p => p.isAlive && p.uid !== vicId).map(p => `
                                    <div onclick="witchKill('${p.uid}')" class="flex flex-col items-center">
                                        ${RoleImg(p.roleId, 'w-8 h-8')}
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="nextStep()" class="w-full py-3 bg-stone-700 rounded text-stone-300">Ne rien faire</button>
                        `;
                    } else if (step.type === 'REVEAL') {
                        contentHtml = `
                            <div class="bg-stone-800 p-4 rounded mb-6 text-center">
                                ${state.nightKills.length === 0 ? '<p class="text-green-500 font-bold">Le village se r√©veille complet !</p>' : 
                                `<div><p class="text-red-500 mb-2 font-bold">Morts cette nuit :</p>${state.nightKills.map(uid => {
                                    const p = state.players.find(x => x.uid === uid);
                                    if(p.isAlive) killPlayer(uid, 'Nuit'); 
                                    return `<div class="flex items-center justify-center gap-2 mb-1">${RoleImg(p.roleId, 'w-6 h-6')} ${getRole(p.roleId).name}</div>`;
                                }).join('')}</div>`}
                            </div>
                            <button onclick="nextStep()" class="w-full py-4 bg-amber-600 font-bold rounded shadow text-xl">Continuer</button>
                        `;
                    } else {
                        contentHtml = `
                            <div class="text-8xl mb-6 text-center animate-bounce-slow">${step.image}</div>
                            <button onclick="nextStep()" class="w-full py-4 bg-amber-700 hover:bg-amber-600 text-white font-serif font-bold text-xl rounded-lg shadow-xl">SUIVANT</button>
                        `;
                    }

                    // Main Game Layout
                    app.innerHTML = `
                        <div class="h-full bg-stone-950 flex flex-col relative">
                            <!-- HEADER -->
                            <div class="h-16 flex items-center justify-between px-4 bg-stone-900 border-b border-stone-800">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${state.isDay ? '‚òÄÔ∏è' : 'üåô'}</span>
                                    <div class="leading-none">
                                        <div class="text-[10px] text-stone-500 font-bold uppercase tracking-wider">${state.isDay ? 'JOURN√âE' : 'NUIT'} ${state.turn}</div>
                                        <div class="text-amber-500 font-serif text-lg">${step.title}</div>
                                    </div>
                                </div>
                                <button onclick="if(confirm('Quitter ?')) { state.phase='SETUP'; render(); }" class="text-2xl text-stone-600 hover:text-white">√ó</button>
                            </div>

                            <!-- STORY CONTENT -->
                            <div class="flex-1 overflow-y-auto p-6 flex flex-col items-center bg-[url('https://www.transparenttextures.com/patterns/black-paper.png')]">
                                <div class="w-full max-w-md fade-in">
                                    <p class="text-xl text-stone-300 text-center font-serif italic mb-8 leading-relaxed">"${step.text}"</p>
                                    ${contentHtml}
                                </div>
                            </div>

                            <!-- LOGS & DASHBOARD BTN -->
                            <div class="h-40 bg-stone-900 border-t border-stone-800 flex flex-col">
                                <div class="flex-1 overflow-y-auto p-2 font-mono text-[10px] text-stone-500 space-y-1">
                                    ${state.historyLog.map(l => `<div class="border-l border-stone-700 pl-2">${l}</div>`).join('')}
                                </div>
                                <div class="flex border-t border-stone-800">
                                    <button onclick="toggleDashboard()" class="flex-1 py-3 bg-stone-800 text-amber-500 font-bold flex items-center justify-center gap-2"><span>üë•</span> Village (God Mode)</button>
                                </div>
                            </div>

                            <!-- DASHBOARD OVERLAY -->
                            <div id="dashboard" class="${state.showDashboard ? 'flex' : 'hidden'} absolute inset-0 bg-stone-950/95 z-50 flex-col p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-serif text-amber-500">√âtat du Village</h2>
                                    <button onclick="toggleDashboard()" class="text-3xl">&times;</button>
                                </div>
                                <div class="flex-1 overflow-y-auto grid grid-cols-3 gap-2 content-start">
                                    ${state.players.map(p => `
                                        <div onclick="${p.isAlive ? `killPlayer('${p.uid}', 'MJ')` : `revivePlayer('${p.uid}')`}" class="p-2 border rounded flex flex-col items-center text-center cursor-pointer ${p.isAlive ? 'border-stone-600 bg-stone-800' : 'border-red-900 bg-red-900/20 opacity-60'}">
                                            ${RoleImg(p.roleId)}
                                            <span class="text-[9px] font-bold mt-1 text-stone-300">${getRole(p.roleId).name}</span>
                                            <span class="text-[8px] px-1 rounded ${p.isAlive ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200'}">${p.isAlive ? 'VIVANT' : 'MORT'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                };

                window.renderVictory = function() {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center bg-stone-900 text-center p-6 fade-in">
                            <div class="text-6xl mb-4">üèÜ</div>
                            <h1 class="text-4xl font-serif text-amber-500 font-bold mb-2">VICTOIRE</h1>
                            <h2 class="text-2xl font-bold mb-6">${state.victory.winner}</h2>
                            <p class="text-stone-400 mb-10">${state.victory.reason}</p>
                            <button onclick="state.phase='SETUP';render()" class="px-8 py-3 bg-stone-700 rounded-lg font-bold">Nouvelle Partie</button>
                        </div>
                    `;
                };

                window.toggleLover = function(uid) {
                    const p = state.players.find(x => x.uid === uid);
                    const count = state.players.filter(x => x.isLover).length;
                    
                    if (p.isLover) {
                        p.isLover = false; // Deselect
                    } else {
                        if (count < 2) {
                            p.isLover = true; // Select if space
                        } else {
                            // Do nothing if already 2 selected and clicking a 3rd
                        }
                    }
                    render();
                };

                window.confirmKill = function(uid, type) {
                    const p = state.players.find(x => x.uid === uid);
                    if (confirm(`Tuer ${getRole(p.roleId).name} ?`)) {
                        if (type === 'Nuit') {
                            // Logic Ancien 2 Vies
                            if (p.roleId === 'elder' && state.elderLives > 1 && !state.isDay) {
                                state.elderLives--;
                                alert("L'Ancien a surv√©cu !");
                                log("L'Ancien a surv√©cu √† une attaque.");
                            } else {
                                state.nightKills.push(uid);
                                log(`Attaque sur ${getRole(p.roleId).name}`);
                            }
                        } else {
                            killPlayer(uid, type);
                        }
                        nextStep();
                    }
                };

                window.infectVictim = function(uid) {
                    const p = state.players.find(x => x.uid === uid);
                    state.nightKills = state.nightKills.filter(id => id !== uid);
                    p.roleId = 'simple_wolf';
                    p.isAlive = true;
                    state.infectUsed = true;
                    log(`üê∫ L'Infect P√®re a transform√© une victime en Loup !`);
                    nextStep();
                };

                window.witchHeal = function(uid) {
                    state.nightKills = state.nightKills.filter(id => id !== uid);
                    state.witchUsed.life = true;
                    log("La Sorci√®re a utilis√© la potion de VIE.");
                    nextStep();
                };

                window.witchKill = function(uid) {
                    state.nightKills.push(uid);
                    state.witchUsed.death = true;
                    log("La Sorci√®re a utilis√© la potion de MORT.");
                    nextStep();
                };

                window.toggleDashboard = function() {
                    state.showDashboard = !state.showDashboard;
                    render();
                };

                window.render = function() {
                    if (state.phase === 'SETUP') renderSetup();
                    else if (state.phase === 'REVIEW') renderReview();
                    else if (state.phase === 'GAME') renderGame();
                    else if (state.phase === 'VICTORY') renderVictory();
                };

                // Init
                render();

            } catch (err) {
                // Catch synchronous errors in init
                window.onerror(err.message, 'script', 0, 0, err);
            }
        });
    </script>
</body>
</html>